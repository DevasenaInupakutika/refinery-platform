{% extends "base.html" %}
{% load humanize %}
{% load markup %}

{% block head_html %}
	<link href="{{ STATIC_URL }}styles/css/tipsy/tipsy.css" rel="stylesheet"/>	    

    <style type="text/css">

svg {
	background-color: none;
	padding: 5px;
	margin-top: 15px;
	margin-bottom: 15px;
}    

.background {
  fill: #FD0;
}

line {
  //stroke: #eee;
}

text.active {
  fill: red;
}

text.matrix-label {
	fill: #222222;
}

text.matrix-label-selected {
	fill: #136382;
	font-weight: bold;
}


rect.frame {
  stroke: #f0f0f0;
}

rect.active {
  fill: red;
}



	.pivot-matrix {
		//background-color: #f00;
	}

    
 	.facet-title {
 		cursor:pointer; 		
 	} 	

 	.facet-value {
 		cursor:pointer; 		
 	}

 	tr th {
 		cursor:pointer;
 	}
 	 
 	.field-name {
 		cursor:pointer;
 	} 
 	 	
 	#facet-view .active {
 		cursor:pointer; 
 		background-color: #3A87AD;
 		color: #fff;
 		font-weight: bold;
 	} 	
 	
 	#pager-view {
 		text-align:right;
 	}

 	#statistics-view {
 		//text-align:right;
 	}
 	#url-view {
 		text-align:right;
 	}

 	.facet-value-list td {
 		padding: 2px; 		
 	}
 	.facet-value-list tr {
 		padding: 2px; 		
 	}
 	
 	.facet-value-list.selected {
 	}
 	
 	.facet-title {
 		margin-top: 10px;
 	}

    </style>
{% endblock %}


{% block title %}
{{ block.super }} - Data Set {{ data_set.name }}
{% endblock %}

{% block subheader %}
 <div class="page-header">
  	<h1>Data Set <small>{{ data_set.name }}</small></h1>
</div>

{% endblock %}

{% block content %}
	<!-- tab headers -->
	
<div class="refinery-panel-tabs">

	<div class="row-fluid">      
	    <ul class="nav nav-tabs" id="tabs">
  			<li><a href="#content" data-toggle="tab">Samples</a></li>
  			{% if has_change_dataset_permission %}
  			<li><a href="#configuration" data-toggle="tab">Attributes</a></li>
  			{% endif %}	
  			{% if has_change_dataset_permission %}
  			<li><a href="#analyses" data-toggle="tab">Analyses</a></li>
  			{% endif %}	
  			<li><a href="#details" data-toggle="tab">Details</a></li>
  			<li><a href="#sharing" data-toggle="tab">Sharing</a></li>
  			<li class="active"><a href="#sample-selection" data-toggle="tab">Sample Selection</a></li>
  	    </ul>
  	</div>
  	
</div>
<div class="refinery-panel refinery-panel-content scrollable">

	{% if data_set %}	
	<!-- tabs -->

	<div class="tab-content">

  		<div class="tab-pane" id="content">			
			<form id="sampleForm" method="post" class="form-inline">
				{% csrf_token %}
			
				<!-- pass study information into the receiving view when posting -->
				<input type="hidden" name="study_uuid" value="{{ study_uuid }}"/>
				
			<div class="row-fluid">
			 	<div class="span12" style="margin-top: 10px; margin-bottom: 15px; background-color: #ededed; padding: 5px 10px 5px 10px; border-radius: 5px;">
 					<label class="control-label" id="statistics-view" style="position: relative; top: 3px;"></label>
  					<span class="controls">
  					<a id="igv-multi-species" href="#" role="button" style="margin-left: 5px" class="btn btn-warning" data-toggle="modal" rel="tooltip" data-placement="bottom" data-html="true" title="Launch IGV with<br>current selection."><i class="icon-bar-chart"></i>&nbsp;&nbsp;View in IGV</a>
					<a href="#" id="help-igv-button" style="height: 20px; width: 20px;"><i class="icon-question-sign" style="font-size: 20px; margin-left: 5px; margin-right: 5px; position: relative; top: 5px;"></i></a>
					
					{% if REFINERY_REPOSITORY_MODE %}
					<!-- CHECK BOXES FOR SELECTING SAMPLES -->					
					{% for work in workflows %}
						<a id="submitReposBtn" data-workflow_id="{{work.uuid}}" role="button" style="margin-left: 5px" class="btn  btn-warning disabled" rel="tooltip" data-placement="bottom" data-html="true" title=""><i class="icon-download"></i>&nbsp;&nbsp;Download as Archive</a>
						<a href="#" id="help-download-button" style="height: 20px; width: 20px;"><i class="icon-question-sign" style="font-size: 20px; margin-left: 5px; margin-right: 5px; position: relative; top: 5px;"></i></a>
					{% endfor %}
					
					{% else %}
					<!-- DROP DOWN BUTTONS FOR MULTIPLE WORKFLOWS --> 
					<select class="combobox" name="workflow_choice" id="workflow_choice">
						<option></option>
						{% for work in workflows %}
							<option value="{{work.uuid}}">{{work.name}}</option>
						{% endfor %}
					</select>
					<a class="btn" id="submitSamplesBtn">Apply</a> &nbsp;	
					
					{% endif %}
					
					
					<!-- <a class="btn" id="profile-viewer-session-link" href="#">Profile</a> -->					
 					<label class="control-label" style="font-size: large; margin-left: 15px; margin-right: 5px; position: relative; top: 3px;">Showing</label>
  					<span class="controls">
						<div class="btn-group annotation-buttons" data-toggle="buttons-radio">
						  	<button type="button" id="data-button" data-toggle="button" class="btn btn-warning active"  rel="tooltip" data-placement="bottom" data-html="true" title="View (primary) data files<br>included in this data set.">Data</button>
						  	<button type="button" id="annotation-button" data-toggle="button" class="btn btn-warning" rel="tooltip" data-placement="bottom" data-html="true" title="View annotation files<br>associated with this data set.">Annotation</button>
						</div>					
						<a href="#" id="help-data-annotation-button" style="height: 20px; width: 20px;"><i class="icon-question-sign" style="font-size: 20px; margin-left: 5px; margin-right: 5px; position: relative; top: 5px;"></i></a>
  					</span>

  					<span id="node-set-manager-panel">  					
	 					<label class="control-label" style="font-size: large; margin-left: 15px; margin-right: 5px; position: relative; top: 3px;">Selection</label>
						<span id="node-set-manager-controls"></span>  					
  					</span>  					
				</div>
			</div>

			<div class="row-fluid">
			 	
			 	<div class="span2">
						<ul class="nav nav-pills" id="navigation-tabs">
						  <li class="active"><a href="#facet-view" data-toggle="pill">Facets</a></li>
						</ul> 		
						<div id="facet-view" class="accordion"></div>
			 	</div>	
			 	
			 	<div class="span10"> 			
					
					<div class="tabbable">
						<ul class="nav nav-pills" id="navigation-tabs">
						  <li class="active"><a href="#table-view-tab" data-toggle="pill">List</a></li>
						  <li><a href="#pivot-view-tab" data-toggle="pill">Matrix</a></li>
						</ul>
			
						<div class="tab-content">
						  <div class="tab-pane active fade in" id="table-view-tab">
						  	<span class="dropdown">
							  <a href="#" class="dropdown-toggle btn btn-mini btn-default" data-toggle="dropdown"><i class="icon-wrench"></i>&nbsp;Columns&nbsp;<i class="icon-caret-down"></i></a>							   
							  <ul class="dropdown-menu" id="field-view" role="menu" aria-labelledby="dLabel">
								<!-- dropdown to control columns included in the table -->
							  </ul>
							</span>
							
							<div id="items-per-page-buttons" style="margin-left: 15px;" class="btn-group" data-toggle="buttons-radio">
								<!-- buttons to control number of rows per page -->
							</div>					
							
							<div id="table-view"></div>
							<div id="pager-view"></div>
						  </div>
						  <div class="tab-pane fade in" id="pivot-view-tab">
						  	<div id="pivot-view">			  		
						  	</div>			  	
						  	<div id="pivot-matrix">
						  		<!-- the matrix -->
						  	</div>
						  </div>
						</div>
					</div>			
					
				</div>
				
			</div>
			
			<div class="row-fluid">
			 	<div class="span12">
				 	<div hidden id="url-view"></div>
			 	</div>		 
			</div>
		</form>
	</div>

	{% if has_change_dataset_permission %}
  	<div class="tab-pane" id="configuration">
		<div class="refinery-header">
			<span class="refinery-header-left">
				<h3>Configuration</h3>
			</span>
		</div>

		<div class="refinery-subheader">
			<h4>Attribute Order and Visibility</h4>
		</div>
		<div id="configurator-panel">
		</div>	
  	</div>
  	{% endif %}	

	{% if has_change_dataset_permission %}
  	<div class="tab-pane" id="analyses">
		<div class="refinery-header">
			<span class="refinery-header-left">
				<h3>Analyses</h3>
			</span>
		</div>
		<p>
		{% if data_set.analysis_set.all|length > 0 %}	
			{% for analysis in data_set.analysis_set.all %}
					<a href="{% url analysis_status analysis.uuid %}">{{ analysis.name }}</a>
					{% if analysis.project.is_catch_all %}
						(unassigned)
					{% else %}
						(Project <a href="{% url project analysis.project.uuid %}">{{ analysis.project.name }}</a>)
					{% endif %}  
					<br/>
			{% endfor %}
		{% else %}
			<i>None.</i>
		{% endif %}
		</p>		
  	</div>
  	{% endif %}	

	<div class="tab-pane" id="details">
			
			<div class="refinery-header">
				<span class="refinery-header-left">
					<h3>{{ data_set.name }}</h3>
				</span>
			</div>

			<div class="refinery-subheader">
				<h4>Summary</h4>
			</div>
			<p>{% if data_set.summary %} {{ data_set.summary|markdown:"safe" }} {% else %} <i>None provided.</i>{% endif %}</p>
			
			<div class="refinery-subheader">
				<h4>Description</h4>
			</div>
			<p>{% if data_set.description %} {{ data_set.description|markdown:"safe" }} {% else %} <i>None provided.</i>{% endif %}</p>
			
			<div class="refinery-subheader">
				<h4>Shortcut Name</h4>
			</div>
			<p>{% if data_set.slug %} {{ data_set.slug }} {% else %} <i>None provided.</i>{% endif %}</p>
			
			{% if not REFINERY_REPOSITORY_MODE %}
				<div class="refinery-header">
					<span class="refinery-header-left">
						<h3>Studies</h3>
					</span>
				</div>
				{% for study in studies %}
				<p><strong>{{study.identifier}}</strong>: {{study.title}}</p>
				<ul>
				{% for assay in study.assay_set.all %}
					<!-- <li>Assay - <a href="{% url data_set_manager_contents study.uuid assay.uuid %}">{{assay}}</a></li> -->
					<li>Assay - {{assay}}</li> 
				{% endfor %}
				</ul>
				{% endfor %}
			{% endif %}
		
			<div class="refinery-header">
				<span class="refinery-header-left">
					<h3>Files</h3>
				</span>
			</div>

			<span class="refinery-subheader">
				<h3>Meta Data</h3>
			</span>
			{% if isatab_archive or pre_isatab_archive %}
				{% load core_extras %}
				{% if isatab_archive %}
				<p><a href="{{isatab_archive.get_full_url}}">{{isatab_archive.uuid|simple_name}}</a> ({{isatab_archive.get_file_size|filesizeformat}})</p>
				{% endif %}
				{% if pre_isatab_archive %}
				<p><a href="{{pre_isatab_archive.get_full_url}}">{{pre_isatab_archive.uuid|simple_name}}</a> ({{pre_isatab_archive.get_file_size|filesizeformat}})</p>
				{% endif %}
			{% else %}
				<p><i>Not available.</i></p>
			{% endif %}

			<span class="refinery-subheader">
				<h3>Data Files</h3>
			</span>
			<p>{{ data_set.file_count }} files using {{ data_set.file_size|filesizeformat }}</p>
								
			<div class="refinery-header">
				<span class="refinery-header-left">
					<h3>History</h3>
				</span>
			</div>
			<p>Current version <i>{{ data_set.get_version_details.version }}</i> created <i>{{ data_set.get_version_details.date }}</i>.
			Data set created <i>{{ data_set.creation_date }}</i>. Last modified <i>{{ data_set.modification_date }}</i>.</p>

			<a class="btn" href="{% url data_set_edit data_set.uuid %}">Edit</a>
		</div>
		

	  	<div class="tab-pane" id="sharing">
			<div class="refinery-header">
				<span class="refinery-header-left">	
					<h3>Sharing</h3>
				</span>
			</div>
			<div class="refinery-subheader">
				<h4>Owner</h4>
			</div>
			<p><a href="{% url user data_set.get_owner.get_profile.uuid %}">{% if data_set.get_owner.get_full_name %}{{ data_set.get_owner.get_full_name }}{% else %}{{ data_set.get_owner }}{%endif%}</a></p>
		
			{% if data_set.get_groups|length > 0 %}
			<div class="refinery-subheader">
				<h4>Groups</h4>
			</div>
				<p>
				{% for perm in data_set.get_groups %}
						<a href="{% url group perm.group.uuid %}">{{ perm.group.name }}</a>&nbsp;
						{% if perm.read %}
							<i class="icon-eye-open"></i>
						{% endif %}
						{% if perm.change %}
							<i class="icon-pencil"></i>
						{% endif %}
				{% endfor %}
				</p>
			{% endif %}
	  		
	  	</div>

	  	<div class="tab-pane fade in active" id="sample-selection">
			<div class="refinery-header">
				<span class="refinery-header-left">	
					<h3>Sample Selection</h3>
				</span>
			</div>


<script type="text/template" id="sample-selector-facet-value-view-template">
	<span><%= name %></span> <span><%= count %></span>: <span><%= isSelected %></span>      	
</script>
				
<script type="text/template" id="sample-selector-facet-view-template">
    <div class="view">
      <b><span><%= name %></span></b> [<span><%= count %><span>]
      	<ul class="facet-value-list"></ul>      	
    </div>
</script>
								
			<div id="sample-selector-facet-view" style="background-color: yellow;">
			</div>
				
	  		
	  	</div>


	</div>
			
	{% else %}
	    <p>No valid data set.</p>
	{% endif %}
	</div>
	
<!-- Modal -->
<div id="igvModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Launch IGV</h3>
  </div>
  <div class="modal-body" id="myModalBody">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>


</div>

{% endblock %}

{% block script %}
	<!-- adding spinner -->
	<script language="javascript" type="text/javascript" src="http://fgnass.github.com/spin.js/dist/spin.min.js"></script>

	<script language="javascript" type="text/javascript">
	    var opts = {
	    lines: 13, // The number of lines to draw
	    length: 4, // The length of each line
	    width: 2, // The line thickness
	    radius: 6, // The radius of the inner circle
	    corners: 1, // Corner roundness (0..1)
	    rotate: 0, // The rotation offset
	    color: '#000', // #rgb or #rrggbb
	    speed: 1, // Rounds per second
	    trail: 60, // Afterglow percentage
	    shadow: false, // Whether to render a shadow
	    hwaccel: false, // Whether to use hardware acceleration
	    className: 'spinner', // The CSS class to assign to the spinner
	    zIndex: 2e9, // The z-index (defaults to 2000000000)
	    top: 'top', // Top position relative to parent in px
	    left: 'top' // Left position relative to parent in px
	    };
	</script>
	    
    <script type="text/javascript" src="{{ STATIC_URL }}js/d3/d3.v2.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/d3/fisheye.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootbox/bootbox.min.js"></script>

    <script type="text/javascript" src="{{ STATIC_URL }}js/underscore/underscore.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/backbone/backbone.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/backbone-relational/backbone-relational.js"></script>

	<!-- Refinery libraries -->
	<script type="text/javascript">
		var REFINERY_BASE_URL = "{{ REFINERY_BASE_URL }}";
		var REFINERY_API_BASE_URL = "http://" + REFINERY_BASE_URL + "/" + "api" + "/" + "v1" + "/";
		var REFINERY_SOLR_BASE_URL = "{{ REFINERY_SOLR_BASE_URL }}";
		var externalStudyUuid = "{{ assay_uuid }}";		
		var externalAssayUuid = "{{ study_uuid }}";
		
		{% if REFINERY_REPOSITORY_MODE %}
		var REFINERY_REPOSITORY_MODE = true;
		{% else %}
		var REFINERY_REPOSITORY_MODE = false;
		{% endif %}
		
		{% if user.is_authenticated %}
		var REFINERY_USER_AUTHENTICATED = true;
		{% else %}
		var REFINERY_USER_AUTHENTICATED = false;
		{% endif %}
	</script>	
	
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/solr/solr_utilities.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/solr/solr_client.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/solr/solr_query.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/solr/solr_response.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/data_set_manager/sample_selector.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/tipsy/jquery.tipsy.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/viewers/pivot-matrix.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/refinery/contents_workflow.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/contents.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/data_set_manager/data_set_configurator.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/refinery/core/node_set_manager.js"></script>

	<script type="application/javascript">
		$(document).ready(function () {
	    	$("[rel=tooltip]").tooltip();
	    	
	    	$("#help-igv-button").click( function(event) {
   				bootbox.alert(
	   				"<h3><i class=\"icon-bar-chart\"></i>&nbsp;&nbsp;View in IGV</h3>" +
					"<p>" +
					"The selected files can be viewed in IGV (<a href=\"http://www.broadinstitute.org/igv\">Integrative Genomics Viewer</a>) along with the meta data shown in the table. " +
					"IGV is launched through <a href=\"http://www.java.com/en/download/faq/java_webstart.xml\">Java WebStart</a>. This means that the software will be launched even if IGV is not installed on your computer. <b>Java needs to be installed for Java WebStart to be available</b>." +
					"</p>" +
					"<p>" +
					"Once you have selected a of files and the clicked the \"View in IGV\" button (and selected a genome build) a <b>JNLP</b> file named \"igv.jnlp\" will be downloaded to your computer." +
					"</p>" +
					"<p>" +
					"Many browsers will automatically open the downloaded JNLP file to launch the Java WebStart application. <b>If IGV is not launched by your browser after the file was downloaded, you need to launch IGV manually by double-clicking the downloaded JNLP file</b>." +
					"</p>"
				);
			});
			
	    	$("#help-download-button").click( function(event) {
   				bootbox.alert(
	   				"<h3><i class=\"icon-download\"></i>&nbsp;&nbsp;Download as Archive</h3>" +
					"<p>" +
					"The selected files can be bulk downloaded as an archive file if you are logged in and if you have selected 20 or less files." +
					"</p>" +
					"<p>" +
					"Archives are created on demand and will require some time to be processed. After clicking the \"Download as Archive\" button you will be taken to a progress page. You can leave this page at any time." +
					"</p>" +
					"<p>" +
					"You will receive an email once the archive is ready for downloading. You can also monitor progress on the homepage in the \"Downloads\" section if you are logged in." +
					"</p>"
				);
			});	    		    	
				    		    	
	    	$("#help-data-annotation-button").click( function(event) {
   				bootbox.alert(
	   				"<h3>Showing Data or Annotation Files</h3>" +
					"<p>" +
					"Data sets can have associated \"annotation\" files that will be included when you launch IGV with a set of selected data files. " +
					"To view available annotation files select \"Annotation\". To switch back to the data files select \"Data\"." +
					"</p>"
				);
			});	    		    	
				    		    	
	  	});	  	
	</script>
			    			        
{% endblock %}  
